知乎用户对特朗普和希拉里的看法——基于爬虫和文本挖掘技术的分析
================
Ye Ling

摘要
----

学了R语言后就一直手痒，想从浩瀚的网络中抓一些数据来练练手。最近学习了爬虫终于可以一试身手了。

我写了一个专爬知乎内容的爬虫，只需输入知乎话题编号（如19552910，对应php语言)，就可以抓取该话题下所有的精华问题，以及每个问题下排名前十的最佳回答，包括回答的全部正文，作者，发布日期，点赞数和评论数。

本文从知乎上分别抓取了讨论美国大选的两位主角特朗普和希拉里的所有精华问答，共有18000多篇，并用文本挖掘技术加以分析。让我们看看知乎用户对特朗普和希拉里是怎么看的吧。有种观点认为知乎对特朗普是一边倒的支持，数据是否支持这种看法呢？

爬虫的编写
----------

本文爬虫主要调用了rvest包，rvest是抓取静态网页的利器，使用起来远比RCurl包便捷。当然缺点是对动态加载的网页就无能为力了。

rvest最主要的三个函数是read\_html()，html\_nodes和html\_text()。功能如下：

read\_html()：传入网址和编码方式（中文网页一般是UTF-8），即可读取整个网页。 html\_nodes()：传入读取的网页和css节点，定位到所有符合要求的节点位置。 html\_text()：传入html\_nodes()的定位结果，提取所有节点下的文本内容，以向量的形式保存。

完整的爬虫如下：

``` r
library(rvest)
library(magrittr)  # 管道运算符

# 输出一个数字，表示该话题的精华有多少页，需要传入话题编号
get_zhihu_page <- function(topic) {  
  paste0("https://www.zhihu.com/topic/", topic, "/top-answers") %>%
    read_html(encoding="UTF-8") %>%
    html_nodes(".zm-invite-pager > span> a:nth-child(1)") %>%
    html_text() %>%
    extract(3) %>%
    as.numeric()
}
#get_zhihu_page(20023724)  # 结果正确
#get_zhihu_page(19674181)

# 获取话题下第n页所有问题的网址
# 第一页和其它页网址不一样，分别处理
page2url <- function(n, topic) {
  if (n==1) {
    qstn <- paste0("https://www.zhihu.com/topic/", topic, "/top-answers") %>%
      read_html(encoding="UTF-8") %>%
      html_nodes("div.feed-item > div:nth-child(6) > div:nth-child(1) > h2:nth-child(1) > a:nth-child(1)") %>%
      html_attr("href") %>%           # 获取全文链接
      extract(grep("/question/", .))  #筛选出有用的链接
  }
  else {
    qstn <- paste0("https://www.zhihu.com/topic/", topic, "/top-answers?page=", n) %>%
      read_html(encoding="UTF-8") %>%
      html_nodes("div.feed-item > div:nth-child(6) > div:nth-child(1) > h2:nth-child(1) > a:nth-child(1)") %>%
      html_attr("href") %>% # 获取全文链接
      extract(grep("/question/", .))    #筛选出有用的链接
  }
  sub("http://www.zhihu.com", "", qstn) %>%
    paste0("https://www.zhihu.com", .)
}


# 该话题下所有精华问题的网址
get_zhihu_qstn <- function(topic) { 
  get_zhihu_page(topic) %>%
    c(1:.) %>%
    sapply(page2url, topic) %>%
    unlist
}
#test <- get_zhihu_qstn(19674181)  # 结果正确
#get_zhihu_qstn(20023724)          # 测试成功

# 从问题的网址获取最热门的十条回答，组成data.frame形式
# css节点的获取：用火狐浏览器打开相应的网页，鼠标停在需要抓取的内容的位置，右键查看元素，即跳至查看器相应位置，
# 在该位置点右键，选复制-> css选择器即可。
# 再复制几个同类型内容的css节点，观察异同，保留相同的部分，删去不同的部分（从冒号开始，包括冒号，一直删到">"前）。
# 这样的节点就对应了这一类内容的所有内容
qstn2ans <- function(url) {
  web <- read_html(url, encoding="UTF-8")
  
  question <- web %>%
    html_nodes("span.zm-editable-content") %>%
    html_text()
  
  author <- web %>%
    html_nodes("div.zm-item-answer > div:nth-child(6) > div:nth-child(1) > span") %>%
    html_text() %>%
    tm::stripWhitespace()
  
  text <- web %>%
    html_nodes("div.zm-item-answer > div:nth-child(7) > div:nth-child(2)") %>% 
    html_text()
  
  zan <- web %>%
    html_nodes("div.zm-item-answer > div:nth-child(5) > button:nth-child(1) > span:nth-child(2)") %>%
    html_text()
  
  date <- web %>%
    html_nodes("div.zm-item-answer > div:nth-child(9) > div:nth-child(1) > a:nth-child(1)") %>%
    html_text()  
  
  commt_count <- web %>%
    html_nodes("div.zm-item-answer > div:nth-child(9) > div:nth-child(1) > a:nth-child(2)") %>%
    html_text() %>%
    tm::stripWhitespace()
  
  data.frame(question=question, author=author, 
             text=text, zan=zan, date=date, 
             commt_count=commt_count, stringsAsFactors = F)
}

#tmp <- qstn2ans("https://www.zhihu.com/question/20594192")

# 用户需要调用的函数
# 传入话题编号，获得所有精华问答
get_zhihu_ans <- function(topic) {   # 输入话题编号
  ans <- get_zhihu_qstn(topic) %>%     # 得到所有问题网址
    lapply(qstn2ans) %>%
    Reduce(rbind, .)
  
  write.csv(ans, paste0("E:/QUANT/text mining/ans_of_", topic, ".csv"))
  return(ans)
}
```

数据清洗
--------

先来看看抓取的特朗普数据"ans\_of\_trp"和希拉里数据"ans\_of\_hlr"的结构。

``` r
#data("ans_of_trp")
test1 <- c("abe")
str(test1)
```

    ##  chr "abe"

Including Code
--------------

You can include R code in the document as follows:

``` r
summary(cars)
```

    ##      speed           dist    
    ##  Min.   : 4.0   Min.   :  2  
    ##  1st Qu.:12.0   1st Qu.: 26  
    ##  Median :15.0   Median : 36  
    ##  Mean   :15.4   Mean   : 43  
    ##  3rd Qu.:19.0   3rd Qu.: 56  
    ##  Max.   :25.0   Max.   :120

Including Plots
---------------

You can also embed plots, for example:

![](知乎用户对特朗普和希拉里的看法_files/figure-markdown_github/pressure-1.png)

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
